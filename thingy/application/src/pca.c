#include "../include/pca.h"
#include <stdint.h>

void pca_doTransform(float *bufs[PCA_NUM_INPUT_BUFS]);
float *pca_getResultBuf();

static float resultBuffer[PCA_RESULT_SIZE] = {0};

static const float means[PCA_ROWS] = {187.93906179245283, 3.3574150943396224, 3.0221235849056605, 2.795220283018868, 2.53495, 2.2452830188679247, 2.1967698113207548, 2.2364627358490563, 1.9554966981132076, 29.747005660377358, 3.322728773584906, 2.996733962264151, 2.6802834905660378, 2.469272641509434, 2.3481325471698113, 2.2340896226415095, 2.3487014150943395, 2.0781448113207546, 47.71869150943397, 3.825752830188679, 3.611129716981132, 3.2403787735849057, 2.8760490566037737, 2.609282075471698, 2.562229716981132, 2.408827358490566, 2.219177358490566, 359.93773254716984, 37.240802830188684, 37.42081745283019, 36.81116226415094, 38.326214622641515, 38.83721273584906, 41.751825000000004, 42.37447594339623, 38.69058396226415, 192.5365183962264, 39.42709952830189, 38.72652075471698, 38.0197537735849, 39.17454433962264, 40.525245754716984, 42.92126698113208, 43.99259669811321, 39.46539528301887, 235.7399687264151, 25.0220424009434, 24.23376273584906, 24.796630188679245, 25.360394811320752, 25.832056603773587, 26.754741981132074, 26.813799056603774, 24.677370754716982};

static const float deviations[PCA_ROWS] = {3.905456579189738, 1.8711521012967534, 1.6842365855889145, 1.509629661278302, 1.369041751485805, 1.2107239932473663, 1.1841465941542602, 1.2649841737872207, 1.4835094361543202, 3.820233903977613, 1.7539747025246997, 1.6126608122173922, 1.4470678976100175, 1.3313832072452063, 1.2163693668769082, 1.1861483129312578, 1.3265491182785298, 1.6308675458610637, 4.631197423313057, 2.108047479693693, 1.9966205111940212, 1.7708143192409205, 1.5240884740849963, 1.3766952824144156, 1.3251096072728143, 1.4130122682393487, 1.7826065311669483, 41.277490534607374, 19.908455510486263, 20.33347822711184, 20.369525849144193, 21.459032717141568, 23.058830052807792, 23.34927262042365, 24.50234064564973, 30.900249894247015, 43.94959027441877, 20.73520472966524, 20.792910343172068, 20.94417649413971, 21.015371869449314, 22.93969534750413, 24.409786791259748, 24.89103051319037, 30.001439120613902, 27.361022978501776, 13.49567048619659, 12.6144436379915, 13.259654191399703, 13.367565976924368, 14.295689976702892, 14.02063155660836, 14.316369267123582, 18.66964519569924};

static const int8_t eigenVecReduced[PCA_ROWS][PCA_COLS] = {{3, -12, 83, 59, 26, -15, 11, -13, -17, 9, -28, 37, 32, -26, 2, 4, 26, 2, 8},
                                                           {-1, 9, -61, -36, 10, 5, -20, -26, -2, 35, 53, -86, 57, -24, -17, 16, -56, 48, -14},
                                                           {0, 2, -53, -35, -13, 12, -11, -43, 9, 17, 44, 0, 67, 10, 32, 0, -17, -13, -23},
                                                           {-2, 7, -55, -54, -18, 1, 7, -55, -41, 45, -13, -20, 18, 6, -14, -26, 32, -5, -48},
                                                           {0, 3, -62, -41, -29, 4, -11, -32, 38, -10, 1, 56, -11, -30, 51, 31, 30, 30, 59},
                                                           {2, 12, -59, -53, -38, 14, 18, -30, -46, 8, -64, -14, -23, 14, -41, 6, 30, -22, 0},
                                                           {-9, 8, -72, -21, -8, 37, -23, 0, 59, 10, 30, 62, -39, -47, 9, 14, -9, 29, 50},
                                                           {0, 7, -76, -48, -5, 13, 20, 25, -58, -22, -56, -21, 0, 39, -21, -6, 54, -14, -22},
                                                           {-1, 6, -45, -7, 4, 36, -15, 38, 73, 2, 8, 49, -39, -46, -19, -87, 12, -46, 47},
                                                           {-1, 9, 0, -24, -101, -60, -47, 36, 1, -15, -4, 6, -23, 12, -17, -28, -40, 12, 1},
                                                           {1, -5, 1, 22, 7, 51, 27, 34, 58, 11, 62, -66, -51, -27, -61, -3, 35, -14, -66},
                                                           {1, -1, 0, 15, 12, 25, 35, -76, -11, -29, 44, 49, -1, 0, -100, -51, -67, -37, -5},
                                                           {13, 2, 13, 6, 21, 21, 69, -34, 14, 82, 18, -5, -33, -6, -51, 18, -19, 58, 9},
                                                           {3, 2, 12, 6, 61, 25, -21, -87, 20, -3, -40, 14, 10, -27, 26, 12, 36, -3, -60},
                                                           {-2, 1, -4, -5, 16, 9, 114, -7, -31, 60, -32, 39, -20, -7, 22, 29, -26, 43, 37},
                                                           {-9, 0, -30, 7, 101, 13, -51, -37, 24, -21, -65, -26, -26, 41, 14, 20, -18, -22, 14},
                                                           {-8, 2, -41, 11, 41, 36, 94, 61, -48, 35, 17, 41, 31, -32, 34, -1, -3, -38, -34},
                                                           {-2, -3, -28, 10, 91, 17, -24, -16, 34, -15, -20, -28, -46, 68, -28, 39, -39, 14, 22},
                                                           {3, 2, 1, 19, 17, 83, 11, -16, -11, -15, -12, -53, 11, 0, 74, -79, 64, -39, 44},
                                                           {-1, 7, -8, -4, 28, -49, 21, -13, 33, -22, 76, -41, -2, 15, -18, -68, 91, 44, -23},
                                                           {5, 0, -11, -14, 36, -58, -11, -77, 3, -21, 23, 41, 29, -67, 4, -9, -2, -80, -31},
                                                           {1, 4, -18, -16, 2, -95, 35, -23, 51, -18, -40, 0, -23, -4, 13, -34, -4, 29, -24},
                                                           {-1, 4, -14, -1, 61, -76, -15, 8, -33, 14, -1, 20, 23, -70, -38, -19, 33, -16, 22},
                                                           {2, -4, -12, 3, 1, -74, 85, -7, 60, -55, -36, -9, 11, 9, -6, 24, 41, 10, 15},
                                                           {-1, 0, -35, 3, 71, -70, -29, 59, -32, 42, 42, -13, -8, -5, 10, -8, 18, 9, 33},
                                                           {-6, -4, -40, -15, 11, -27, 86, 44, 46, -82, -11, 7, 24, 12, -8, 35, -51, -40, -31},
                                                           {0, 0, -33, 7, 62, -54, -41, 63, -34, 59, 3, 25, -9, 16, -9, 12, 11, -1, -4},
                                                           {-120, 24, 0, 27, -14, -2, -1, -7, -2, 11, -2, -4, 5, 1, 0, -1, 7, -2, -1},
                                                           {-73, 11, -7, 11, 8, -12, -7, -28, -9, 6, -16, 20, -88, -2, 17, -17, -17, 27, -33},
                                                           {-72, 10, 2, 22, -13, 3, 21, -9, 20, 11, -7, -5, 69, 14, -26, -14, 40, 41, 32},
                                                           {-68, 6, -9, 14, 0, -22, -13, -2, -35, -15, 30, -18, 26, -17, 12, 24, -64, -40, 13},
                                                           {-67, 7, -1, 5, -10, 17, -2, 37, 21, -3, 18, -11, 30, 10, -19, 54, 32, -63, 11},
                                                           {-70, 4, -28, 14, 9, 19, 12, 22, -8, -48, 11, -22, -36, -23, 13, 41, 0, -15, -3},
                                                           {-80, 10, -13, 12, 8, 11, 0, 20, 26, 28, -25, 37, -1, 13, -3, -20, 12, 15, -22},
                                                           {-82, 17, 0, 14, -4, -6, 1, -26, -37, -31, -7, -8, 12, -12, 13, -40, -27, 33, -2},
                                                           {-67, 16, 20, 3, -16, -21, -3, -34, 30, 49, 12, 14, -8, 32, -11, -22, 16, -2, -4},
                                                           {26, 127, 12, 2, -1, 1, -4, 1, 6, -6, 1, 5, -2, 0, 3, 5, -3, 1, -4},
                                                           {13, 76, 1, 3, 12, -5, 15, 9, 12, -3, -12, -56, 39, -22, 48, -21, -38, 6, 34},
                                                           {10, 70, 7, -5, -3, -9, -4, -16, -10, 37, 28, 21, -38, 51, -44, 36, 17, -52, 4},
                                                           {8, 66, 11, 0, -7, 8, -7, 10, -22, -11, -1, 60, -10, 20, -16, 11, 54, -42, -19},
                                                           {5, 64, 3, 10, 6, 18, -29, 2, -10, -41, -5, 45, 8, 20, 1, 21, 0, 41, -50},
                                                           {18, 69, -13, 14, 15, 9, 8, 25, 1, -23, 1, 10, 0, -22, -11, -24, -20, 49, -61},
                                                           {14, 80, -3, 16, 16, 10, 3, 17, 32, -6, 12, -21, 9, -9, 42, 5, 2, 24, -9},
                                                           {7, 92, 10, -4, 0, 2, 4, -2, -42, -15, -16, -6, -8, -35, -16, -10, -3, 22, 23},
                                                           {6, 60, 18, -5, -10, -30, 23, -25, 43, 55, 12, -31, 5, 41, 7, 10, -28, -93, 49},
                                                           {37, -4, -68, 118, -36, -11, 0, -17, -8, 2, 2, 1, -8, 0, 9, 7, 5, 0, 4},
                                                           {-10, 10, 39, -57, 23, -22, 42, -7, -27, -28, 26, -28, -49, 42, 14, -52, -1, -16, 70},
                                                           {-9, 7, 33, -39, 13, 20, -22, 49, 47, -1, -74, -25, 35, -76, -74, 2, -9, -12, -2},
                                                           {-8, -1, 35, -57, 6, 0, 13, -16, -6, -33, 88, 18, -38, -22, 67, 65, 26, 0, -11},
                                                           {-8, 0, 18, -49, 29, 21, -12, 4, 23, -20, 33, 56, 92, 71, -39, 40, 43, 50, 30},
                                                           {-11, -17, 26, -56, 34, 16, 0, 34, -34, -39, 32, 20, -30, 37, 19, -47, -33, 6, -51},
                                                           {-4, -1, 21, -63, 30, 24, 0, 24, 31, 35, -26, 43, 42, 27, 22, -74, -53, 2, 2},
                                                           {-20, 6, 41, -67, 13, 14, -3, -15, -39, -25, -9, -33, -32, -91, -45, 43, 19, 19, 48},
                                                           {-14, -2, 41, -55, -16, -21, -2, 11, 53, 81, -35, -19, -21, -15, 56, 27, 8, -27, -80}};
static const float eigenScaler = 0.004012381205024216;

static void normalize(float *bufs[PCA_NUM_INPUT_BUFS]);

void pca_doTransform(float *bufs[PCA_NUM_INPUT_BUFS])
{
    normalize(bufs);

    for (int col = 0; col < PCA_COLS; col++)
    {
        resultBuffer[col] = 0;
        int idxCntr = 0;
        for (int row = 0; row < PCA_ROWS; row++)
        {
            resultBuffer[col] += bufs[idxCntr / PCA_SINGLE_BUF_SIZE][idxCntr % PCA_SINGLE_BUF_SIZE] * (float)eigenVecReduced[row][col] * eigenScaler;
            idxCntr++;
        }
    }
}

float *pca_getResultBuf()
{
    return resultBuffer;
}

static void normalize(float *bufs[PCA_NUM_INPUT_BUFS])
{
    int idxCntr = 0;
    for (int buf = 0; buf < PCA_NUM_INPUT_BUFS; buf++)
    {
        bufs[buf][idxCntr % PCA_SINGLE_BUF_SIZE] = (bufs[buf][idxCntr % PCA_SINGLE_BUF_SIZE] - means[idxCntr]) / deviations[idxCntr];
        idxCntr++;
    }
}